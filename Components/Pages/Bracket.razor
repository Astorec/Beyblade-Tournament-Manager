@page "/Bracket"
@using BeybladeTournamentManager.ApiCalls.Challonge
@using BeybladeTournamentManager.ApiCalls.Challonge.Data
@using Challonge.Api
@using Challonge.Objects
@using System.Text.RegularExpressions
@inject IAutentication _challongeAuth
@inject IMatches _matches
@inject IParticipants _participants
@inject ITournamentManager _tournamentInfo

<MudPaper Elevation="0">
    <MudContainer>
        @if (!matchesLoaded)
        {
            <MudCard>
                <MudText class="d-flex justify-center">Loading Matches</MudText>
            </MudCard>
        }
        else if(matchesLoaded && matches.Count == 0)
        {
            <MudCard>
                <MudText class="d-flex justify-center">No Matches Found</MudText>
            </MudCard>
        }
        else
        {
            <MudGrid>
                <MudItem xs="12">
                    <div class="d-flex justify-content-between"> <!-- Flex container for rounds -->
                        @foreach (var roundGroup in matches.GroupBy(m => m.Round).OrderBy(g => g.Key))
                        {
                            <div class="round"> <!-- Each round is a flex column -->

                                <MudText Typo="Typo.h6" Class="my-2">Round: @roundGroup.Key</MudText>

                                @foreach (var match in roundGroup)
                                {
                                    @if (playerNames.ContainsKey(match.Player1Id.Value))
                                    {
                                        finals = true;
                                        if (!finalsMatches.Contains(match))
                                        {
                                            finalsMatches.Add(match);
                                        }

                                    }
                                    else
                                    {
                                        <div class="bracket-match"> <!-- Each match in the round -->
                                            <MudCard Elevation="4" class="d-flex rounded-pill mud-theme-primary">
                                                <MudCardContent>
                                                    <div class="d-flex justify-center">
                                                        <div class="d-flex flex-column mr-8 mb-7" Width="70%" Elevation="0">
                                                            <div class="d-flex flex-row pl-8 align-center">
                                                                <div class="d-flex mt-6 justify-center">
                                                                    <MudText class="d-flex align-center align-content-center justify-center ml-2" style="width: 50%;">@(GetPlayer(match, match.Player1Id.Value).Result)</MudText>
                                                                </div>
                                                                <div class="d-flex mt-6 justify-center flex-grow-1 flex-gap-4 ml-2">
                                                                    <MudTextField class="d-flex flex-grow" Margin="Margin.Dense" FullWidth="false" style="width: 100%;" Value="@GetScore(match, 1)" Variant="Variant.Outlined"/>
                                                                </div>
                                                            </div>                                                            
                                                            <div class="d-flex flex-row pl-8 align-center">
                                                                <div class="d-flex mt-6 justify-center">
                                                                    <MudText class="d-flex align-center align-content-center justify-center ml-2" style="width: 50%;">@(GetPlayer(match, match.Player2Id.Value).Result)</MudText>
                                                                </div>
                                                                <div class="d-flex mt-6 justify-center flex-grow-1 flex-gap-4 ml-2">
                                                                    <MudTextField class="d-flex flex-grow" Margin="Margin.Dense" FullWidth="false" style="width: 100%;" Value="@GetScore(match, 2)" Variant="Variant.Outlined"/>
                                                                </div>
                                                            </div>
                                                        
                                                        </div>
                                                    </div>
                                                </MudCardContent>

                                            </MudCard>

                                        </div>
                                    }
                                }
                            </div>
                        }
                    </div>
                </MudItem>

                <MudItem xs="12">
                    <div class="d-flex ml-n20">
                        @if (finalsMatches.Count > 0)
                        {
                            @foreach (var roundGroup in finalsMatches.GroupBy(m => m.Round).OrderBy(g => g.Key))
                            {
                                <div class="finals-round">
                                    <!-- Each round in the tournament -->
                                    @if (finalsMatches.Count - roundGroup.Key == 1)
                                    {
                                        <MudText Typo="Typo.h6" Class="my-2">Finals</MudText>
                                    }
                                    else if (finalsMatches.Count - roundGroup.Key == 2)
                                    {

                                        <MudText Typo="Typo.h6" Class="my-2">Semi-Finals</MudText>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.h6" Class="my-2">Round: @roundGroup.Key</MudText>
                                    }

                                    @foreach (var match in roundGroup)
                                    {

                                        
                                        <div class="bracket-match"> <!-- Each match in the round -->
                                            <MudCard Elevation="4" class="d-flex rounded-pill mud-theme-secondary">
                                                <MudCardContent>
                                                    <div class="d-flex justify-center">
                                                        <div class="d-flex flex-column mr-8 mb-7" Width="70%" Elevation="0">
                                                            <div class="d-flex flex-row pl-8 align-center">
                                                                <div class="d-flex mt-6 justify-center">
                                                                    <MudText class="d-flex align-center align-content-center justify-center ml-2" style="width: 50%;">@(GetPlayer(match, match.Player1Id.Value).Result)</MudText>
                                                                </div>
                                                                <div class="d-flex mt-6 justify-center flex-grow-1 flex-gap-4 ml-2">
                                                                    <MudTextField class="d-flex flex-grow" Margin="Margin.Dense" FullWidth="false" style="width: 100%;" Value="@GetScore(match, 1)" Variant="Variant.Outlined"/>
                                                                </div>
                                                            </div>                                                            
                                                            <div class="d-flex flex-row pl-8 align-center">
                                                                <div class="d-flex mt-6 justify-center">
                                                                    <MudText class="d-flex align-center align-content-center justify-center ml-2" style="width: 50%;">@(GetPlayer(match, match.Player2Id.Value).Result)</MudText>
                                                                </div>
                                                                <div class="d-flex mt-6 justify-center flex-grow-1 flex-gap-4 ml-2">
                                                                    <MudTextField class="d-flex flex-grow" Margin="Margin.Dense" FullWidth="false" style="width: 100%;" Value="@GetScore(match, 2)" Variant="Variant.Outlined"/>
                                                                </div>
                                                            </div>
                                                        
                                                        </div>
                                                    </div>
                                                </MudCardContent>
                                            </MudCard>

                                        </div>
                                    }
                                </div>
                            }
                        }
                    </div>
                </MudItem>
            </MudGrid>
        }
    </MudContainer>
</MudPaper>

@code {
    ChallongeClient _client;
    private MudTable<Player> _table;
    List<Player> players = new List<Player>();
    List<Challonge.Objects.Match> matches = new List<Challonge.Objects.Match>();
    List<Challonge.Objects.Match> finalsMatches = new List<Challonge.Objects.Match>();
    List<Participant> participants = new List<Participant>();
    Tournament tournament;

    private Dictionary<long, string> playerNames = new Dictionary<long, string>();
        private Dictionary<long, MatchScores> matchScores = new Dictionary<long, MatchScores>();
    private Dictionary<long, List<string>> matchList = new Dictionary<long, List<string>>();
    int rounds = 0;
    int player1Score = 0;
    int player2Score = 0;
    bool matchesLoaded = false;
    bool canAddMatch = false;
    bool finals = false;
    bool grandFinals = false;
    string tournamentUrl;


        protected override async Task OnInitializedAsync()
    {
        _client = _challongeAuth.GetClient();
        tournamentUrl = GetTournamentCode(_challongeAuth.GetSettings().CurrentTournament);

        if (_client != null)
        {
            matches = await _matches.GetMatches(tournamentUrl);
            participants = await _participants.GetParticipants(tournamentUrl);

            foreach (var participant in participants)
            {
                playerNames.Add(participant.Id, await GetPlayerName(participant.Id));
            }
            if (matches.Any())
            {
                rounds = matches.Max(m => m.Round);
            }
            else
            {
                rounds = 0; // or handle the case where there are no matches
            }
            matchesLoaded = true;
            StateHasChanged();
        }
    }

    public async Task<string> GetPlayerName(long? pid)
    {
        try
        {
            var participant = await _participants.GetParticipantById(tournamentUrl, Convert.ToInt32(pid.Value));
            return participant.Name;
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            return "Player Not Found";
        }
    }

    public async Task<string> GetPlayer(Challonge.Objects.Match match, long? id)
    {

        if (tournament.GroupStagesEnabled && !playerNames.ContainsKey(id.Value))
        {
            // Look for the player in the participant list
            var participant = participants.FirstOrDefault(p => p.GroupPlayerIds.FirstOrDefault() == id);
            return participant.Name;

        }
        else if (playerNames.ContainsKey(id.Value))
        {
            return playerNames[id.Value];
        }
        else
        {
            return "TBA";
        }
    }

    public int GetScore(Challonge.Objects.Match match, int player)
    {
        if(player == 1)
        {
            var scoreOneScore = match.Scores.Select(s => s.PlayerOneScore).FirstOrDefault();
            return scoreOneScore;
        }
        else
        {
            var scoreTwoScore = match.Scores.Select(s => s.PlayerTwoScore).FirstOrDefault();
            return scoreTwoScore;
        }
    }

    public void UpdateMatchScore(long matchId, int player1Score, int player2Score)
{
    if (matchScores.ContainsKey(matchId))
    {
        matchScores[matchId].PlayerOneScore = player1Score;
        matchScores[matchId].PlayerTwoScore = player2Score;
    }
    else
    {
        matchScores.Add(matchId, new MatchScores { PlayerOneScore = player1Score, PlayerTwoScore = player2Score });
    }
}
    private void UpdatePlayer1Score(long matchId, int value)
    {
        player1Score = value;
        UpdateMatchScore(matchId, player1Score, player2Score);
    }

    private async Task UpdatePlayer2Score(long matchId, int value)
    {
        player2Score = Convert.ToInt32(value);
        UpdateMatchScore(matchId, player1Score, player2Score);
    }


    private int ConvertToInt(string value)
    {
        return int.TryParse(value, out int result) ? result : 0; // Convert string to int, defaulting to 0 on failure
    }

    public class MatchScores{
        public int PlayerOneScore { get; set; }
        public int PlayerTwoScore { get; set; }
    }

    string GetTournamentCode(string url)
    {
        string pattern = @"(?<=\.com/).*$";

        return Regex.Match(url, pattern).Value;
    }

}

<style>
    .bracket-round {
        display: flex;
        flex-direction: column;
        position: relative;
        justify-content: center;
    }

    .d-flex.justify-content-between>.bracket-round {
        margin-right: 450px;
        /* Adjust the right margin to control spacing between rounds */
        flex: 0 1 auto;
        /* Adjust the flex-grow, flex-shrink, and flex-basis values as needed */
        width: auto;
        /* Adjust the width to control how much space each round takes up */
    }

    .bracket-container {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
    }

    .round {
        margin: 0 20px;
    }

    .finals-round {
        margin: 0 200px;
    }

    .bracket-match {
        padding: 10px;
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
    }


    .round:last-child .bracket-match::after {
        display: none;
    }

    .bracket-match .mud-card {
        min-height: 150px;
        /* Adjust based on your content */
        min-width: 200px;
        /* Adjust based on your content */
        height: 150px;
        /* Ensures a fixed height */
        width: 300px;
        /* Ensures a fixed width */
        display: flex;
        flex-direction: column;
        justify-content: space-around;
        /* Distributes space around items inside the card */
    }

    .center-content {
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
        /* For text alignment if flexbox doesn't cover your needs */
        height: 100%;
        /* Ensure it takes full height of its container */
    }
</style>