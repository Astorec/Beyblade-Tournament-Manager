@using BeybladeTournamentManager.ApiCalls.Challonge
@using BeybladeTournamentManager.ApiCalls.Challonge.Data
@using BeybladeTournamentManager.Helpers
@using BeybladeTournamentManager.Components.Pages.Components
@using Challonge.Api
@using Challonge.Objects
@using System.Text.RegularExpressions
@inject IAutentication _challongeAuth
@inject IPlayerHelper _playerHelper
@inject ITournamentManager _tournamentInfo
@page "/"

<MudPaper class="d-flex flex-coloumn justify-center gap-3 mt-3" Elevation="0">
    <NewTournament AddedTournament="AddedNewTournament" />
    <AddTournemantByUrl PreviousUrls="previousUrls" OnUrlSelected="HandleUrlAdded" />

    <AddNewPlayer PlayerToAdd="AddPlayer" />


</MudPaper>
<MudPaper class="d-flex mt-2" Width="100%">
    <MudContainer MaxWidth="MaxWidth.Medium">
        <MudTable T="Player" Items="@players">
            <HeaderContent>
                <MudTh>Name</MudTh>
                <MudTh>Region</MudTh>
                <MudTh>Check-In</MudTh>
                <MudTh>Check-In Time</MudTh>
            </HeaderContent>

            <RowTemplate>
                <MudTd>@context.Name</MudTd>
                <MudTd>
                    <MudSelect T="string" Value="@context.region" ValueChanged="@(e => context.region = e)">
                        @foreach (var item in regions)
                        {
                            <MudSelectItem T="string" Value="@item">@item</MudSelectItem>
                        }
                    </MudSelect>
                </MudTd>
                <MudTd>
                    <MudSwitch T="bool" Value="@context.CheckInState" @onclick="@(e => OnCheckInStateChanged(context))"
                        Color="Color.Primary" />
                </MudTd>
                <MudTd>
                    <MudText>@context.CheckInTime</MudText>
                </MudTd>
            </RowTemplate>
        </MudTable>
    </MudContainer>
</MudPaper>




@code {
    ChallongeClient? _client;
    TournamentDetails currentTournament = new TournamentDetails();
    private bool loading = true;
    private MudTable<Player>? _table;
    List<Player> players = new List<Player>();
    List<string> regions = new List<string>{"London", "Norwich", "Oxfordshire", "Yorkshire", "South West", "South East",
"North West", "North East",
"Midlands", "Wales", "Scotland", "Ireland"};
    Dictionary<string, List<Player>> playerCache = new Dictionary<string, List<Player>>();
    private Dictionary<string, string> previousUrls = new Dictionary<string, string>();
    private string _tournamentUrl = "";
    public string currentTournamentUrl = "";
    private bool isInit = false;

    protected override async Task OnInitializedAsync()
    {
        if (_challongeAuth.GetClient() != null)
        {
            _client = _challongeAuth.GetClient();

            if (_challongeAuth.GetSettings().PreviousTournements != null)
            {
                previousUrls = _challongeAuth.GetSettings().PreviousTournements;
            }

            if (_challongeAuth.GetSettings().CurrentTournament != "")
            {
                currentTournamentUrl = _challongeAuth.GetSettings().CurrentTournament;
                await GetParticipentsViaURL(currentTournamentUrl);
            }
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            currentTournamentUrl = _challongeAuth.GetSettings().CurrentTournament;
            await GetParticipentsViaURL(currentTournamentUrl);
        }
    }

    private async Task AddedNewTournament(bool added)
    {
        if (added)
        {
            currentTournamentUrl = _challongeAuth.GetSettings().CurrentTournament;
            await GetParticipentsViaURL(currentTournamentUrl);
            StateHasChanged();
        }
    }

    private async Task AddPlayer(Player player)
    {
        if (_client == null)
        {
            return;
        }

        try
        {

            ParticipantInfo participantInfo = new ParticipantInfo
                {
                    Name = player.Name,
                    Email = player.Email
                };
            var participant = await _client.CreateParticipantAsync(currentTournamentUrl, participantInfo);

            player.ChallongeId = participant.Id;
            players.Add(player);
            await _playerHelper.AddNewPlayer(currentTournament.relatedSheetName, player);
            StateHasChanged();
        }
        catch (Exception e)
        {
            Console.WriteLine(e.Message);
        }
    }
    private async Task HandleUrlAdded(string url)
    {
        var currentSettings = _challongeAuth.GetSettings();

        var code = GetTournamentCode(url);

        if (!previousUrls.ContainsKey(code))
        {
            previousUrls.Add(code, url);
            currentSettings.PreviousTournements = previousUrls;
        }

        currentSettings.CurrentTournament = code;
        _challongeAuth.SaveSettings(currentSettings);

        // Get the tournament info so we can save it to the settings file. This is so we can at least
        // access the spreadsheet name as it will error otherwise when trying to get the sheet information
        // to get the correct sheet info.
        var settings = _challongeAuth.GetSettings();
        var tourneyInfo = await _client.GetTournamentByUrlAsync(code);
        string sheetName = $"{tourneyInfo.Name} - {tourneyInfo.StartAt.Value.Date.ToString("dd/MM/yyyy")}";

        currentTournament = _tournamentInfo.SetTournamentDetails(code, tourneyInfo.Name, sheetName);
        settings.CurrentTournamentDetails = currentTournament;

        _challongeAuth.SaveSettings(settings);


        // Get the participants
        await GetParticipentsViaURL(code);

        // Get the leaderboard information. Through this if the tournament was set up through Challonge, it will create
        // a new sheet based on that infroamtion.
        var leaderboard = await _playerHelper.GetLeaderboard(sheetName);
        LeaderboardHelper leaderboardHelper = new LeaderboardHelper();

        // If the leaderboard is empty, we can add players to the sheet, this is more so if the tournament was set up
        // on Challonge previously and already has players and data in it.
        if (leaderboard.Count == 0)
        {
            await _playerHelper.AddPlayersToSheet(sheetName, await leaderboardHelper.NewPlayers(players, leaderboard, code, _client));
        }
    }

    string GetTournamentCode(string url)
    {
        string pattern = @"(?<=\.com/).*$";
        Console.WriteLine(Regex.Match(url, pattern).Value);
        return Regex.Match(url, pattern).Value;
    }

    public async Task GetParticipentsViaURL(string code)
    {
        Console.WriteLine("In GetParticipentsViaURL");
        if (_client == null)
        {
            return;
        }

        if (code != "" && _client != null)
        {

            try
            {
                Console.WriteLine("In Try of GetParticipentsViaURL");
                if (playerCache.ContainsKey(code))
                {
                    var cachedPlayers = playerCache[code];

                    bool areEqual = players.SequenceEqual(cachedPlayers);

                    if (!areEqual)
                    {
                        players.Clear();
                        players.AddRange(cachedPlayers);
                    }

                }
                else
                {

                    Console.WriteLine("In Else of GetParticipentsViaURL");
                    var participants = await _client.GetParticipantsAsync(code);

                    Console.WriteLine("Got Participants");
                    List<Participant> participantsList = participants.ToList();

                    players.Clear();
                    _playerHelper.ClearPlayers();
                    await AddPlayerFromParticipant(participantsList);
                    players = _playerHelper.GetCurrentPlayers();

                    // Create a new list instance to avoid reference issues
                    var playersCopy = new List<Player>(players);
                    playerCache[code] = playersCopy;
                }

                currentTournamentUrl = code;
                var currentSettings = _challongeAuth.GetSettings();
                _challongeAuth.SaveSettings(currentSettings);
            }
            catch (Exception e)
            {
                Console.WriteLine(e.Message);
            }
            finally
            {
                StateHasChanged();
            }

        }
    }

    async Task AddPlayerFromParticipant(List<Participant> participants)
    {
        List<Player> tempList = new List<Player>();
        foreach (var participant in participants)
        {
            Player p = new Player
                {
                    Name = participant.Name,
                    region = "",
                    ChallongeId = participant.Id,
                    CheckInState = participant.CheckedIn,
                    CheckInTime = participant.CheckedInAt
                };

            tempList.Add(p);
        }

        _playerHelper.AddPlayers(tempList, currentTournament.relatedSheetName);
    }

    public bool HandleCheckIn(bool isCheckedIn)
    {
        return isCheckedIn;
    }
    private async Task OnCheckInStateChanged(Player context)
    {
        if (_client == null)
        {
            return;
        }

        try
        {
            var participant = await _client.GetParticipantAsync(currentTournamentUrl, context.ChallongeId);

            // Update the player list
            var index = players.FindIndex(x => x.ChallongeId == context.ChallongeId);

            // if the check in true update time
            if (!context.CheckInState)
            {

                players[index].CheckInState = true;
                players[index].CheckInTime = DateTime.Now;
                await _client.CheckInParticipantAsync(participant);
            }
            else
            {
                players[index].CheckInState = false;
                players[index].CheckInTime = null;

                await _client.UndoCheckInParticipantAsync(participant);
            }

            StateHasChanged();
        }
        catch (Exception e)
        {
            Console.WriteLine(e.Message);
        }
    }
}